<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>fix broken MySQL replication (Relay log read failure) slave crash - d4nc1ntr33</title><meta name="robots" content="noindex,nofollow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="preload" href="https://d4nc1ntr33.funkysys.org/assets/dynamic/fonts/publicsans/publicsans.woff2" as="font" type="font/woff2" crossorigin><link rel="stylesheet" href="https://d4nc1ntr33.funkysys.org/assets/css/style.css?v=0e21f761d0bfa96fcac910b371493717"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://d4nc1ntr33.funkysys.org/fix-broken-mysql-replication-relay-log-read-failure-slave-crash/"},"headline":"fix broken MySQL replication (Relay log read failure) slave crash","datePublished":"2024-05-14T23:54","dateModified":"2024-05-15T11:33","description":"How to fix a broken MySQL / MariaDB replication (Relay log read&hellip;","author":{"@type":"Person","name":"d4nc1ntr33","url":"https://d4nc1ntr33.funkysys.org/authors/dario/"},"publisher":{"@type":"Organization","name":"d4nc1ntr33"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript></head><body><div class="content"><div class="left-bar"><div class="left-bar__inner"><header class="header"><a class="logo" href="https://d4nc1ntr33.funkysys.org/">d4nc1ntr33</a><nav class="navbar"><button class="navbar__toggle" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><span class="navbar__toggle__box"><span class="navbar__toggle__inner">Menu</span></span></button><ul class="navbar__menu"><li><a class="tltp" href="https://d4nc1ntr33.funkysys.org/tags/" target="_self" aria-label="Notes">Notes <span>Notes</span></a></li><li><a href="https://d4nc1ntr33.funkysys.org/tags/" target="_self" aria-label="Bookmarks"><span>Bookmarks</span></a></li></ul></nav><a class="logo logo--atbottom" href="./">d4nc1ntr33</a></header></div></div><main class="main"><article class="post"><div class="main__inner"><div class="post__meta"><div class="post__author"><div><a href="https://d4nc1ntr33.funkysys.org/authors/dario/" class="post__author__name">d4nc1ntr33</a></div></div><div class="post__date"><time datetime="2024-05-14T23:54">May 14, 2024</time></div></div><header class="post__header"><h1 class="post__title">fix broken MySQL replication (Relay log read failure) slave crash</h1></header><div class="post__entry"><h1><a href="https://www.claudiokuenzler.com/blog/1332/how-to-fix-broken-mysql-replication-relay-log-read-failure-on-slave-server">How to fix a broken MySQL / MariaDB replication (Relay log read failure) after a crash on the slave server</a></h1><p class="newsfooter"> </p><p>Whenever you are using a MySQL replication (whether this is on a MySQL, MariaDB or Percona installation), you should be monitoring them. The open source <a target="" href="https://www.claudiokuenzler.com/monitoring-plugins/check_mysql_slavestatus.php">monitoring plugin check_mysql_slavestatus</a> does this job perfectly and will alert you when the replication stopped (for whatever reason).</p><p>This has happened a couple of days ago and monitoring correctly informed about a stopped replication on the slave server (inf-mysql02-p):</p><p class="quote">CRITICAL: Slave_SQL_Running: No</p><h2>Hardware crash caused data corruption in replication</h2><p>A first analysis quickly showed the physical server of this virtual slave server had crashed and the sudden power loss corrupted the replication:</p><pre class="consoletext"><code>root@inf-mysql02-p:~# <span class="consolecommand">uptime</span></code><br><code> 10:12:17 <strong>up 1 day</strong>, 13:52,  1 user,  load average: 0.24, 0.24, 0.25</code></pre><p><em>The uptime should be more than 1 day, just saying ;-).</em></p><p>At the next MariaDB start up, the replication tried to continue but then ran into an error. The MySQL error log clearly shows this:</p><pre class="consoletext">root@inf-mysql02-p:~# <span class="consolecommand">cat /var/log/mysql/error.log</span><br><strong>2023-07-22 20:19:59 0 [Note] Starting MariaDB</strong> 10.6.12-MariaDB-0ubuntu0.22.04.1-log source revision  as process 246<br>2023-07-22 20:20:00 0 [Note] mariadbd: Aria engine: starting recovery<br>recovered pages: 0% 10% 20% 32% 43% 53% 63% 73% 83% 93% 100% (0.0 seconds); tables to flush: 3 2 1 0<br> (0.0 seconds); <br>2023-07-22 20:20:00 0 [Note] mariadbd: Aria engine: recovery done<br>2023-07-22 20:20:00 0 [Note] InnoDB: Compressed tables use zlib 1.2.11<br>2023-07-22 20:20:00 0 [Note] InnoDB: Number of pools: 1<br>2023-07-22 20:20:00 0 [Note] InnoDB: Using crc32 + pclmulqdq instructions<br>2023-07-22 20:20:00 0 [Note] InnoDB: Initializing buffer pool, total size = 2147483648, chunk size = 134217728<br>2023-07-22 20:20:00 0 [Note] InnoDB: Completed initialization of buffer pool<br>2023-07-22 20:20:00 0 [Note] InnoDB: Starting crash recovery from checkpoint LSN=110224548081,110225247704<br>2023-07-22 20:20:04 0 [Note] InnoDB: Starting final batch to recover 27522 pages from redo log.<br>2023-07-22 20:20:08 0 [Note] InnoDB: 128 rollback segments are active.<br>2023-07-22 20:20:08 0 [Note] InnoDB: Removed temporary tablespace data file: "./ibtmp1"<br>2023-07-22 20:20:08 0 [Note] InnoDB: Creating shared tablespace for temporary tables<br>2023-07-22 20:20:08 0 [Note] InnoDB: Setting file './ibtmp1' size to 12 MB. Physically writing the file full; Please wait ...<br>2023-07-22 20:20:08 0 [Note] InnoDB: File './ibtmp1' size is now 12 MB.<br>2023-07-22 20:20:08 0 [Note] InnoDB: 10.6.12 started; log sequence number 110541786264; transaction id 18208946<br>2023-07-22 20:20:08 0 [Note] InnoDB: Loading buffer pool(s) from /var/lib/mysql/ib_buffer_pool<br>2023-07-22 20:20:08 0 [Note] Plugin 'FEEDBACK' is disabled.<br>2023-07-22 20:20:08 0 [Note] InnoDB: Buffer pool(s) load completed at 230722 20:20:08<br>2023-07-22 20:20:08 0 [Warning] 'innodb-locks-unsafe-for-binlog' was removed. It does nothing now and exists only for compatibility with old my.cnf files.<br><strong>2023-07-22 20:20:08 0 [Note] Recovering after a crash using /var/log/mysql/mysql-bin</strong><br>2023-07-22 20:20:08 0 [Note] Starting table crash recovery...<br><strong>2023-07-22 20:20:08 0 [Note] Crash table recovery finished.</strong><br>2023-07-22 20:20:08 0 [Note] Server socket created on IP: '0.0.0.0'.<br>2023-07-22 20:20:08 0 [Warning] Neither --relay-log nor --relay-log-index were used; so replication may break when this MariaDB server acts as a replica and has its hostname changed. Please use '--log-basename=#' or '--relay-log=mysqld-relay-bin' to avoid this problem.<br>2023-07-22 20:20:08 5 [Note] Slave I/O thread: Start asynchronous replication to master 'repl@10.10.76.161:3306' in log 'mysql-bin.004699' at position 132501043<br><strong>2023-07-22 20:20:08 6 [Note] Slave SQL thread initialized, starting replication in log 'mysql-bin.004699' at position 132501043, relay log './mysqld-relay-bin.013738' position: 132239277</strong><br>2023-07-22 20:20:08 0 [Note] /usr/sbin/mariadbd: ready for connections.<br>Version: '10.6.12-MariaDB-0ubuntu0.22.04.1-log'  socket: '/run/mysqld/mysqld.sock'  port: 3306  Ubuntu 22.04<br><strong>2023-07-22 20:20:08 6 [ERROR] Error in Log_event::read_log_event(): 'Event invalid', data_len: 0, event_type: 0</strong><br>2023-07-22 20:20:08 6 [ERROR] Error reading relay log event: slave SQL thread aborted because of I/O error<br>2023-07-22 20:20:08 6 [ERROR] Slave SQL: Relay log read failure: Could not parse relay log event entry. The possible reasons are: the master's binary log is corrupted (you can check this by running 'mysqlbinlog' on the binary log), the slave's relay log is corrupted (you can check this by running 'mysqlbinlog' on the relay log), a network problem, or a bug in the master's or slave's MariaDB code. If you want to check the master's binary log or slave's relay log, you will be able to know their names by issuing 'SHOW SLAVE STATUS' on this slave. Internal MariaDB error code: 1594<br>2023-07-22 20:20:08 6 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread with "SLAVE START". We stopped at log 'mysql-bin.004699' position 132501043<br>2023-07-22 20:20:08 6 [Note] Slave SQL thread exiting, replication stopped in log 'mysql-bin.004699' at position 132501043, master: 10.10.76.161:3306<br>2023-07-22 20:20:08 5 [Note] Slave I/O thread: connected to master 'repl@10.10.76.161:3306',replication started in log 'mysql-bin.004699' at position 132501043</pre><p>The <strong>Error in Log_event::read_log_event() indicates that the replicated event could not be read from the relay log.</strong></p><p>Let's stop the slave process and also take a look at the current slave status:</p><pre class="consoletext">MariaDB [(none)]&gt; <span class="consolecommand">STOP SLAVE;</span><br>Query OK, 0 rows affected (0.005 sec)<br><br>MariaDB [(none)]&gt; <span class="consolecommand">SHOW SLAVE STATUS\G;</span><br>*************************** 1. row ***************************<br>                Slave_IO_State: <br>                   Master_Host: 10.10.76.161<br>                   Master_User: repl<br>                   Master_Port: 3306<br>                 Connect_Retry: 60<br>               Master_Log_File: mysql-bin.004861<br>           Read_Master_Log_Pos: 29553382<br><strong>                Relay_Log_File: mysqld-relay-bin.013738</strong><br><strong>                 Relay_Log_Pos: 132239277</strong><br><strong>         Relay_Master_Log_File: mysql-bin.004699</strong><br>              Slave_IO_Running: No<br>             Slave_SQL_Running: No<br>               Replicate_Do_DB: <br>           Replicate_Ignore_DB: <br>            Replicate_Do_Table: <br>        Replicate_Ignore_Table: <br>       Replicate_Wild_Do_Table: <br>   Replicate_Wild_Ignore_Table: <br>                    Last_Errno: 1594<br>                    Last_Error: Relay log read failure: Could not parse relay log event entry. The possible reasons are: the master's binary log is corrupted (you can check this by running 'mysqlbinlog' on the binary log), the slave's relay log is corrupted (you can check this by running 'mysqlbinlog' on the relay log), a network problem, or a bug in the master's or slave's MariaDB code. If you want to check the master's binary log or slave's relay log, you will be able to know their names by issuing 'SHOW SLAVE STATUS' on this slave.<br>                  Skip_Counter: 0<br><strong>           Exec_Master_Log_Pos: 132501043</strong><br>               Relay_Log_Space: 22250692688<br>               Until_Condition: None<br>                Until_Log_File: <br>                 Until_Log_Pos: 0<br>            Master_SSL_Allowed: No<br>            Master_SSL_CA_File: <br>            Master_SSL_CA_Path: <br>               Master_SSL_Cert: <br>             Master_SSL_Cipher: <br>                Master_SSL_Key: <br>         Seconds_Behind_Master: NULL<br> Master_SSL_Verify_Server_Cert: No<br>                 Last_IO_Errno: 0<br>                 Last_IO_Error: <br>                Last_SQL_Errno: 1594<br>                Last_SQL_Error: Relay log read failure: Could not parse relay log event entry. The possible reasons are: the master's binary log is corrupted (you can check this by running 'mysqlbinlog' on the binary log), the slave's relay log is corrupted (you can check this by running 'mysqlbinlog' on the relay log), a network problem, or a bug in the master's or slave's MariaDB code. If you want to check the master's binary log or slave's relay log, you will be able to know their names by issuing 'SHOW SLAVE STATUS' on this slave.<br>   Replicate_Ignore_Server_Ids: <br>              Master_Server_Id: 1<br>                Master_SSL_Crl: <br>            Master_SSL_Crlpath: <br>                    Using_Gtid: No<br>                   Gtid_IO_Pos: <br>       Replicate_Do_Domain_Ids: <br>   Replicate_Ignore_Domain_Ids: <br>                 Parallel_Mode: optimistic<br>                     SQL_Delay: 0<br>           SQL_Remaining_Delay: NULL<br>       Slave_SQL_Running_State: <br>              Slave_DDL_Groups: 0<br>Slave_Non_Transactional_Groups: 0<br>    Slave_Transactional_Groups: 0<br>1 row in set (0.000 sec)</pre><p>The output shows the same SQL error as seen in the log file.</p><h2>Verify errors in local relay-bin log</h2><p>To verify a problem in the local (replicated) binary log file, we can parse the relay log (mysqld-relay-bin.013738, as seen in the error log and <span class="consolecommand">SHOW SLAVE STATUS</span> output above) using the <span class="consolecommand">mysqlbinlog</span> command. By grepping for capital ERROR the file can be checked for actual errors or corruption:</p><pre class="consoletext">root@inf-mysql02-p:~# <span class="consolecommand">mysqlbinlog /var/lib/mysql/mysqld-relay-bin.013738 | grep ERROR</span><br><strong>ERROR: Error in Log_event::read_log_event(): 'Event invalid', data_len: 0, event_type: 0<br>ERROR: Could not read entry at offset 132239277: Error in log format or read error.</strong></pre><p>Indeed there are errors in this local bin log. And - no surprise - the error matches the log position also seen in the slave status above.</p><p>Luckily the crash only happened on the slave, the master did not suffer from any crash and has therefore consistent data (this can also be manually verified by running <span class="consolecommand">mysqlbinlog</span> on the binary logs on the master, grepping for the string ERROR). This means we can <a target="_blank" href="https://dba.stackexchange.com/questions/53893/mysql-relay-log-corrupted-how-do-i-fix-it-tried-but-failed" rel="noopener">fix this broken replication</a> on the slave server by "re-executing" the events before the corruption!</p><h2>Reset the MySQL slave replication</h2><p>In an older article, I explained <a href="https://www.claudiokuenzler.com/blog/1075/mysql-replication-out-of-sync-full-database-restore-solve-error-1032-could-not-update">how to do a full MySQL replication re-sync</a> when a master-slave replication needs to be rebuilt. A similar approach is used here, by defining the master's binary log (file name) and position. </p><p>We require the following information, which we can extract from above's <span class="consolecommand">SHOW SLAVE STATUS</span> command:</p><ul><li>MASTER_LOG_FILE: The value from Relay_Master_Log_File (mysql-bin.004699)</li><li>MASTER_LOG_POS: The value from Exec_Master_Log_Pos (132501043)</li></ul><div><p>This is basically the information (hopefully) still available on the MariaDB master server where the replication stopped working.</p><p>We can now reset the slave and change the replication "position":</p><pre class="consoletext">mysql&gt; <span class="consolecommand">RESET SLAVE;</span><br>Query OK, 0 rows affected (0.04 sec) <br><br>MariaDB [(none)]&gt; <span class="consolecommand">CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.004699', MASTER_LOG_POS=132501043;</span><br>Query OK, 0 rows affected (0.019 sec)<br><br>MariaDB [(none)]&gt; <span class="consolecommand">START SLAVE;</span><br>Query OK, 0 rows affected (0.000 sec)</pre><h2>Duplicate entry for key PRIMARY events</h2><p>As the replication "goes back in time" and re-executes events before the hardware crash, some errors might appear whie looking at the SHOW SLAVE STATUS. Such a typical error is the following:</p><pre class="consoletext"><code>Last_Error: <strong>Could not execute Write</strong>_rows_v1 event on table app.background_worker_run_info; <strong>Duplicate entry</strong> '32570d3b-5877-4730-b13b-53a2ad9dce4e' <strong>for key 'PRIMARY'</strong>, <strong>Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY</strong>; the event's master log mysql-bin.004699, end_log_pos 132502035</code></pre><p>As this write event already occurred, the unique primary key is already in place. This write error can therefore safely be ignored:</p><pre class="consoletext">MariaDB [(none)]&gt; <span class="consolecommand">STOP SLAVE ; SET GLOBAL sql_slave_skip_counter = 1; START SLAVE;</span></pre><p>There might be a couple of the same DUPLICATE KEY errors. Re-apply the command above until the DUPLICATE KEY errors are gone (in my case I needed to do this 4 times).</p><h2>Replication working again</h2><p>Once the DUPLICATE KEY errors were cleared, the replication started working again:</p><pre class="consoletext">MariaDB [(none)]&gt; <span class="consolecommand">SHOW SLAVE STATUS\G;</span><br>*************************** 1. row ***************************<br><strong>                Slave_IO_State: Waiting for master to send event</strong><br>                   Master_Host: 10.10.76.161<br>                   Master_User: repl<br>                   Master_Port: 3306<br>                 Connect_Retry: 60<br>               Master_Log_File: mysql-bin.004827<br>           Read_Master_Log_Pos: 117549478<br>                Relay_Log_File: mysqld-relay-bin.000010<br>                 Relay_Log_Pos: 4897978<br>         Relay_Master_Log_File: mysql-bin.004702<br><strong>              Slave_IO_Running: Yes<br>             Slave_SQL_Running: Yes</strong><br>               Replicate_Do_DB: <br>           Replicate_Ignore_DB: <br>            Replicate_Do_Table: <br>        Replicate_Ignore_Table: <br>       Replicate_Wild_Do_Table: <br>   Replicate_Wild_Ignore_Table: <br>                    Last_Errno: 0<br>                    Last_Error: <br>                  Skip_Counter: 0<br>           Exec_Master_Log_Pos: 4907180<br>               Relay_Log_Space: 17260963132<br>               Until_Condition: None<br>                Until_Log_File: <br>                 Until_Log_Pos: 0<br>            Master_SSL_Allowed: No<br>            Master_SSL_CA_File: <br>            Master_SSL_CA_Path: <br>               Master_SSL_Cert: <br>             Master_SSL_Cipher: <br>                Master_SSL_Key: <br><strong>         Seconds_Behind_Master: 136974</strong><br> Master_SSL_Verify_Server_Cert: No<br>                 Last_IO_Errno: 0<br>                 Last_IO_Error: <br>                Last_SQL_Errno: 0<br>                Last_SQL_Error: <br>   Replicate_Ignore_Server_Ids: <br>              Master_Server_Id: 1<br>                Master_SSL_Crl: <br>            Master_SSL_Crlpath: <br>                    Using_Gtid: No<br>                   Gtid_IO_Pos: <br>       Replicate_Do_Domain_Ids: <br>   Replicate_Ignore_Domain_Ids: <br>                 Parallel_Mode: optimistic<br>                     SQL_Delay: 0<br>           SQL_Remaining_Delay: NULL<br>       Slave_SQL_Running_State: Write_rows_log_event::write_row(-1) on table `background_worker_run_info`<br>              Slave_DDL_Groups: 0<br>Slave_Non_Transactional_Groups: 0<br>    Slave_Transactional_Groups: 1141<br>1 row in set (0.000 sec)</pre><p>The slave now needs to catch up (Seconds_Behind_Master) and was also seen by monitoring:</p><div class="thumbnail"><img loading="lazy" src="https://www.claudiokuenzler.com/graph/news/1332-mysql-replication-slave-behind-master_small.png" alt="Monitoring shows MySQL Slave is behind Master" data-is-external-image="true"></div><p>Eventually the slave caught up with the master a few minutes later.</p><pre class="consoletext">MariaDB [(none)]&gt; <span class="consolecommand">SHOW SLAVE STATUS\G;</span><br>*************************** 1. row ***************************<br>                Slave_IO_State: Waiting for master to send event<br>                   Master_Host: 10.10.76.161<br>                   Master_User: repl<br>                   Master_Port: 3306<br>                 Connect_Retry: 60<br>               Master_Log_File: mysql-bin.004864<br>           Read_Master_Log_Pos: 107935154<br>                Relay_Log_File: mysqld-relay-bin.000495<br>                 Relay_Log_Pos: 107736336<br>         Relay_Master_Log_File: mysql-bin.004864<br>              Slave_IO_Running: Yes<br>             Slave_SQL_Running: Yes<br>[...]<br><strong>       Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</strong><br>              Slave_DDL_Groups: 0<br>Slave_Non_Transactional_Groups: 0<br>    Slave_Transactional_Groups: 95609<br>1 row in set (0.000 sec)</pre></div></div><footer class="post__footer"><div class="post__last-updated">This article was updated on <time datetime="2024-05-15T11:33">May 15, 2024</time></div><div class="post__share"></div></footer></div></article><div class="post__section post__related"><div class="main__inner"><h3 class="post__section__title">Related post</h3><div class="post__related__wrap"><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://d4nc1ntr33.funkysys.org/authors/dario/">d4nc1ntr33</a></div><time datetime="2024-02-22T21:32">Feb 22, 2024 </time><a href="https://d4nc1ntr33.funkysys.org/tags/mariadb/" class="c-card-tag">mariadb</a></div><header class="c-card__header"><h2 class="c-card__title"><a href="https://d4nc1ntr33.funkysys.org/pgless-greatermysqlless-greatersqlite-sqlalchemy/">pg&lt;-&gt;mysql&lt;-&gt;sqlite SQLAlchemy</a></h2><p>Advanced queries with sqlalchemy https://www.slingacademy.com/article/sqlalchemy-how-to-use-group-by-with-count/ https://stackoverflow.com/questions/3890518/convert-mysql-to-sqlite https://github.com/dumblob/mysql2sqlite https://www.rebasedata.com/convert-mysql-to-sqlite-online curl -F 'files[]=@file.sql' 'https://www.rebasedata.com/api/v1/convert?outputFormat=sqlite&amp;errorResponse=zip'&hellip;</p></header></article><article class="c-card"><div class="c-card__meta"><div class="c-card__author"><a href="https://d4nc1ntr33.funkysys.org/authors/dario/">d4nc1ntr33</a></div><time datetime="2024-02-16T23:05">Feb 16, 2024 </time><a href="https://d4nc1ntr33.funkysys.org/tags/flask/" class="c-card-tag">flask</a></div><header class="c-card__header"><h2 class="c-card__title"><a href="https://d4nc1ntr33.funkysys.org/flask-app-ready/">Flask app ready</a></h2><p>https://appseed.us/generator/material-kit/</p></header></article></div></div></div></main><div class="right-bar"><div class="right-bar__inner"><div class="sidebar"><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><div><a href="https://d4nc1ntr33.funkysys.org/authors/dario/" class="authors__title">d4nc1ntr33</a> <span class="authors__meta">Post: 38</span></div></li></ul></section><section class="box tags"><h3 class="box__title">Recommended Topics</h3><ul class="tags__list"><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/android/" class="btn btn--gray">android <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/blamethedev/" class="btn btn--gray">blamethedev <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/crypto/" class="btn btn--gray">crypto <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/dkim/" class="btn btn--gray">dkim <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/dmarc/" class="btn btn--gray">dmarc <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/flask/" class="btn btn--gray">flask <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/flutter/" class="btn btn--gray">flutter <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/go/" class="btn btn--gray">go <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/lighthouse/" class="btn btn--gray">lighthouse <sup>(1)</sup></a></li><li class="tags__item"><a href="https://d4nc1ntr33.funkysys.org/tags/mariadb/" class="btn btn--gray">mariadb <sup>(1)</sup></a></li></ul></section><div class="box copyright">Powered by Funkysys.org</div></div></div></div></div><script defer="defer" src="https://d4nc1ntr33.funkysys.org/assets/js/scripts.min.js?v=12d8fcd46db8fdc7af6797ec26849875"></script><script>var images = document.querySelectorAll('img[loading]');
        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="7" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="https://d4nc1ntr33.funkysys.org/privacy-policy/">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && cbConfig.initialLsState.indexOf(allowedGroup) === -1) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>